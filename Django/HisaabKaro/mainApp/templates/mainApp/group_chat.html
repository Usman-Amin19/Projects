{% extends 'mainApp/base.html' %}
{% load static %}

{% block title %}{{ group.name }} - Group Chat{% endblock %}

{% block content %}
<div class="chat-page-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="chat-header-left">
            <a href="{% url 'mainApp:group_detail' group.id %}" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="group-info">
                <h4>{{ group.name }}</h4>
                <small>{{ group.members.count }} members</small>
            </div>
        </div>
    </div>

    <!-- Chat Messages Container -->
    <div class="chat-messages-container" id="chatMessages">
        <!-- Messages will be loaded here -->
    </div>

    <!-- Chat Input -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button id="imageUploadBtn" class="image-attach-btn">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="Type your message..."
                rows="1"
            ></textarea>
            <button class="chat-send-btn" id="sendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Message Context Menu -->
<div class="context-menu" id="messageContextMenu">
    <div class="context-menu-item" id="copyMessage">
        <i class="fas fa-copy"></i> Copy
    </div>
    <div class="context-menu-item" id="editMessage">
        <i class="fas fa-edit"></i> Edit
    </div>
    <div class="context-menu-item" id="deleteMessage">
        <i class="fas fa-trash"></i> Delete
    </div>
    <div class="context-menu-item" id="downloadImage">
        <i class="fas fa-download"></i> Download
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal fade" id="editMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="editMessageText" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
let chatSocket = null;
let currentGroupId = {{ group.id }};
let currentEditingMessageId = null;
let selectedMessageElement = null;

// WebSocket connection
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/group/${currentGroupId}/chat/`;
    
    chatSocket = new WebSocket(wsUrl);
    
    chatSocket.onopen = function(e) {
        console.log('Chat WebSocket connected');
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'chat_message') {
            addMessageToChat(data.message);
        } else if (data.type === 'recent_messages') {
            loadRecentMessages(data.messages);
        }
    };
    
    chatSocket.onclose = function(e) {
        console.log('Chat WebSocket disconnected');
        setTimeout(connectWebSocket, 3000);
    };
    
    chatSocket.onerror = function(e) {
        console.error('Chat WebSocket error:', e);
    };
}

// Send text message
function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message
        }));
        
        input.value = '';
        autoResizeTextarea(input);
    }
}

// Send image message
async function sendImageMessage(file) {
    const formData = new FormData();
    formData.append('image', file);
    
    try {
        const response = await fetch(`/groups/${currentGroupId}/chat/send-image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            addMessageToChat(data.message);
        } else {
            alert('Error sending image: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending image:', error);
        alert('Error sending image');
    }
}

// Add message to chat
function addMessageToChat(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = `message ${message.is_own ? 'own' : 'other'}`;
    messageElement.dataset.messageId = message.id;
    
    const timestamp = new Date(message.timestamp).toLocaleString();
    let editedText = '';
    
    if (message.edited_at) {
        editedText = '<div class="message-edited">edited</div>';
    }
    
    let content = '';
    if (message.message_type === 'image') {
        content = `<img src="${message.image_url}" alt="Image" class="message-image" onclick="openImageModal('${message.image_url}')">`;
    } else {
        content = `<div class="message-content">${escapeHtml(message.content)}</div>`;
    }
    
    messageElement.innerHTML = `
        <div class="message-container">
            <div class="message-bubble" oncontextmenu="showContextMenu(event, ${message.id}, '${message.message_type}', ${message.is_own})">
                ${content}
                ${editedText}
            </div>
            <div class="message-info">
                ${message.is_own ? 'You' : escapeHtml(message.sender_name)} â€¢ ${timestamp}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Mark this message as read if it's not our own message
    if (!message.is_own) {
        markMessagesAsRead([message.id]);
    }
}

// Load recent messages
function loadRecentMessages(messages) {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    messages.forEach(message => {
        addMessageToChat(message);
    });
    
    // Mark all loaded messages as read
    markMessagesAsRead(messages.map(m => m.id));
}

// Mark messages as read
function markMessagesAsRead(messageIds) {
    if (messageIds.length === 0) return;
    
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'type': 'mark_read',
            'message_ids': messageIds
        }));
    }
}

// Context menu functionality
function showContextMenu(event, messageId, messageType, isOwn) {
    event.preventDefault();
    
    const contextMenu = document.getElementById('messageContextMenu');
    const copyItem = document.getElementById('copyMessage');
    const editItem = document.getElementById('editMessage');
    const deleteItem = document.getElementById('deleteMessage');
    const downloadItem = document.getElementById('downloadImage');
    
    // Reset visibility
    copyItem.style.display = 'flex';
    editItem.style.display = isOwn && messageType === 'text' ? 'flex' : 'none';
    deleteItem.style.display = isOwn ? 'flex' : 'none';
    downloadItem.style.display = messageType === 'image' ? 'flex' : 'none';
    
    // Store current message info
    contextMenu.dataset.messageId = messageId;
    contextMenu.dataset.messageType = messageType;
    selectedMessageElement = event.target.closest('.message');
    
    // Position and show context menu
    contextMenu.style.left = event.clientX + 'px';
    contextMenu.style.top = event.clientY + 'px';
    contextMenu.style.display = 'block';
}

// Copy message content
function copyMessage() {
    if (selectedMessageElement) {
        const content = selectedMessageElement.querySelector('.message-content');
        if (content) {
            navigator.clipboard.writeText(content.textContent);
        }
    }
    hideContextMenu();
}

// Edit message
function editMessage() {
    const messageId = document.getElementById('messageContextMenu').dataset.messageId;
    const content = selectedMessageElement.querySelector('.message-content');
    
    if (content) {
        document.getElementById('editMessageText').value = content.textContent;
        currentEditingMessageId = messageId;
        new bootstrap.Modal(document.getElementById('editMessageModal')).show();
    }
    hideContextMenu();
}

// Save edited message
async function saveEditedMessage() {
    const newContent = document.getElementById('editMessageText').value.trim();
    
    if (!newContent) {
        alert('Message cannot be empty');
        return;
    }
    
    try {
        const response = await fetch(`/groups/${currentGroupId}/chat/message/${currentEditingMessageId}/edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `content=${encodeURIComponent(newContent)}`
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update message in UI
            const messageElement = document.querySelector(`[data-message-id="${currentEditingMessageId}"]`);
            if (messageElement) {
                const contentElement = messageElement.querySelector('.message-content');
                const bubbleElement = messageElement.querySelector('.message-bubble');
                
                if (contentElement) {
                    contentElement.textContent = data.message.content;
                }
                
                // Add edited indicator if not already present
                if (!bubbleElement.querySelector('.message-edited')) {
                    const editedElement = document.createElement('div');
                    editedElement.className = 'message-edited';
                    editedElement.textContent = 'edited';
                    bubbleElement.appendChild(editedElement);
                }
            }
            
            bootstrap.Modal.getInstance(document.getElementById('editMessageModal')).hide();
        } else {
            alert('Error editing message: ' + data.error);
        }
    } catch (error) {
        console.error('Error editing message:', error);
        alert('Error editing message');
    }
}

// Delete message
async function deleteMessage() {
    if (!confirm('Are you sure you want to delete this message?')) {
        hideContextMenu();
        return;
    }
    
    const messageId = document.getElementById('messageContextMenu').dataset.messageId;
    
    try {
        const response = await fetch(`/groups/${currentGroupId}/chat/message/${messageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove message from UI
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.remove();
            }
        } else {
            alert('Error deleting message: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting message:', error);
        alert('Error deleting message');
    }
    
    hideContextMenu();
}

// Download image
function downloadImage() {
    const messageId = document.getElementById('messageContextMenu').dataset.messageId;
    window.location.href = `/groups/${currentGroupId}/chat/message/${messageId}/download/`;
    hideContextMenu();
}

// Hide context menu
function hideContextMenu() {
    document.getElementById('messageContextMenu').style.display = 'none';
    selectedMessageElement = null;
}

// Auto-resize textarea
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Open image modal (simple version)
function openImageModal(imageUrl) {
    window.open(imageUrl, '_blank');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    
    // Send message on Enter
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        autoResizeTextarea(e.target);
    });
    
    // Send button
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    
    // Image upload
    document.getElementById('imageUploadBtn').addEventListener('click', function() {
        document.getElementById('imageInput').click();
    });
    
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            sendImageMessage(file);
            e.target.value = ''; // Clear input
        }
    });
    
    // Context menu items
    document.getElementById('copyMessage').addEventListener('click', copyMessage);
    document.getElementById('editMessage').addEventListener('click', editMessage);
    document.getElementById('deleteMessage').addEventListener('click', deleteMessage);
    document.getElementById('downloadImage').addEventListener('click', downloadImage);
    
    // Save edit button
    document.getElementById('saveEditBtn').addEventListener('click', saveEditedMessage);
    
    // Hide context menu on click outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.context-menu')) {
            hideContextMenu();
        }
    });
    
    // Auto-resize textarea on input
    document.getElementById('chatInput').addEventListener('input', function(e) {
        autoResizeTextarea(e.target);
    });
});
</script>
{% endblock %}
