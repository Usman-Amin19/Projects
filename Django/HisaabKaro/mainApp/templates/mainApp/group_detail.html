{% extends 'mainApp/base.html' %}
{% block title %}{{ group.name }} - HisaabKaro{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Charts Button -->
<button class="charts-button" onclick="openChartModal('group_detail')">
    <i class="fas fa-chart-pie"></i>
    <span>Show Graphs</span>
</button>

<!-- Chat Button -->
<button class="chat-button" onclick="openChatModal({{ group.id }})">
    <i class="fas fa-comments"></i>
    <span>Group Chat</span>
    <span class="unread-badge" id="unreadBadge" style="display: none;">0</span>
</button>

<div class="container mt-4">
    <div class="header">
        <h1>{{ group.name }}</h1>
        <p>{{ group.description|default:"No description" }}</p>
        
        <!-- Balance Information -->
        <div class="balance-info mt-3">
            {% if you_owe %}
                <div class="alert alert-danger">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-arrow-up"></i> You owe PKR {{ balance|floatformat:2|cut:'-' }}
                        </div>
                        {% if has_pending_settlements %}
                            <button class="btn btn-sm btn-secondary" disabled title="You have pending settlement requests">
                                <i class="fas fa-clock me-1"></i>Settlement Pending
                            </button>
                        {% else %}
                            <a href="{% url 'mainApp:settle_up' group.id %}" class="btn btn-sm btn-success">
                                <i class="fas fa-handshake me-1"></i>Settle Up
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% elif you_are_owed %}
                <div class="alert alert-success">
                    <i class="fas fa-arrow-down"></i> You are owed PKR {{ balance|floatformat:2 }}
                    
                    <!-- Show pending settlement requests -->
                    {% if pending_settlements %}
                        <div class="mt-3">
                            <hr>
                            <h6><i class="fas fa-clock me-2"></i>Pending Settlement Requests:</h6>
                            {% for settlement in pending_settlements %}
                            <div class="d-flex justify-content-between align-items-center mt-2 p-2 border rounded">
                                <div>
                                    <strong>{{ settlement.from_user.first_name }} {{ settlement.from_user.last_name }}</strong> 
                                    wants to settle <strong>PKR {{ settlement.amount }}</strong>
                                    <br><small class="text-muted">{{ settlement.created_at|date:"M d, Y H:i" }}</small>
                                    {% if settlement.notes %}
                                        <br><small class="text-muted"><em>"{{ settlement.notes }}"</em></small>
                                    {% endif %}
                                </div>
                                <div>
                                    <small class="d-block text-muted mb-2">Have you received this amount?</small>
                                    <div class="btn-group btn-group-sm">
                                        <form method="post" action="{% url 'mainApp:respond_to_settlement' group.id settlement.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="response" value="approve">
                                            <button type="submit" class="btn btn-success btn-sm" 
                                                    onclick="return confirm('Are you sure you received PKR {{ settlement.amount }} from {{ settlement.from_user.first_name }}?')">
                                                <i class="fas fa-check"></i> Yes
                                            </button>
                                        </form>
                                        <form method="post" action="{% url 'mainApp:respond_to_settlement' group.id settlement.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="response" value="reject">
                                            <button type="submit" class="btn btn-danger btn-sm" 
                                                    onclick="return confirm('Are you sure you want to reject this settlement request?')">
                                                <i class="fas fa-times"></i> No
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-check-circle"></i> All settled up!
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Group Members -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Members ({{ group.members.count }})</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleMembers()">
                <i class="fas fa-users"></i> Show Members
            </button>
        </div>
        <div class="card-body hidden" id="membersSection">
            <div class="row">
                {% for member in group.members.all %}
                <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>{{ member.first_name }} {{ member.last_name }} ({{ member.username }})</span>
                        {% if member == group.created_by %}
                            <span class="badge bg-primary">Admin</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if user == group.created_by %}
            <div class="mt-3">
                <button class="btn btn-sm btn-danger">
                    <i class="fas fa-user-minus"></i> Remove Member
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Invite Link Section (Admin Only) -->
    {% if user == group.created_by %}
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-crown text-warning me-2"></i>Invite Members
            </h5>
            <span class="badge bg-warning text-dark">Admin Only</span>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Share this link with others to invite them to join this group:</p>
            
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="inviteLink" 
                       value="{{ request.scheme }}://{{ request.get_host }}{% url 'mainApp:join_group' group.invite_token %}" 
                       readonly>
                <button class="btn btn-outline-primary" type="button" onclick="copyInviteLink()">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" onclick="shareInviteLink()">
                    <i class="fas fa-share"></i> Share Link
                </button>
                <button class="btn btn-sm btn-warning" onclick="regenerateInviteLink()">
                    <i class="fas fa-sync"></i> Regenerate Link
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Group History -->
    {% if history %}
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Activity</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleHistory()">
                <i class="fas fa-history"></i> Show History
            </button>
        </div>
        <div class="card-body hidden" id="historySection">
            {% for entry in history %}
            <div class="history-entry mb-2 pb-2 border-bottom">
                <div class="d-flex justify-content-between">
                    <span>{{ entry.description }}</span>
                    <small class="text-muted">{{ entry.timestamp|date:"M d, Y H:i" }}</small>
                </div>
                <small class="text-muted">by {{ entry.performed_by.first_name }} {{ entry.performed_by.last_name }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <br/>

    <!-- Group Expenses -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Expenses</h3>
        {% if group.members.count >= 2 %}
            <a href="{% url 'mainApp:add_group_expense_step1' group.id %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Expense
            </a>
        {% else %}
            <button class="btn btn-secondary" disabled title="Need at least 2 members to add expenses">
                <i class="fas fa-plus"></i> Add Expense (Need 2+ members)
            </button>
        {% endif %}
    </div>

    {% if expenses %}
        <div id="expenseContainer">
            {% for expense in expenses %}
            <div class="expense-card">
                <div class="expense-info">
                    <div class="expense-title">{{ expense.title }}</div>
                    <div class="expense-description">{{ expense.description|default:"No description" }}</div>
                    <div class="expense-meta">
                        <span>{{ expense.date|date:"M d, Y" }}</span>
                        <span>Paid by: {{ expense.paid_by.first_name }} {{ expense.paid_by.last_name }}</span>
                        {% if expense.category %}
                            <span class="category-tag">{{ expense.category.name }}</span>
                        {% endif %}
                        <span class="badge bg-info">{{ expense.get_split_type_display }}</span>
                    </div>
                    <div class="participants mt-2">
                        <small class="text-muted">
                            Participants: 
                            {% for participant in expense.participants.all %}
                                {{ participant.first_name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                    </div>
                    
                    <!-- Action Buttons (only show if user is a participant) -->
                    {% if user in expense.participants.all %}
                    <div class="expense-actions mt-2">
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="{% url 'mainApp:edit_group_expense_step1' group.id expense.id %}" class="btn btn-outline-primary" title="Edit Expense">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteExpense({{ expense.id }})" title="Delete Expense">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="showExpenseHistory({{ expense.id }})" title="View History">
                                <i class="fas fa-history"></i> History
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="expense-amount">${{ expense.amount }}</div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h4>No expenses yet</h4>
            <p>Start adding expenses to track shared costs</p>
        </div>
    {% endif %}

    <!-- Group-specific JavaScript Functions -->
    <script>
        // Toggle Functions
        function toggleMembers() {
            const section = document.getElementById('membersSection');
            const btn = event.target.closest('button');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-users"></i> Hide Members';
            } else {
                section.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-users"></i> Show Members';
            }
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const btn = event.target.closest('button');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-history"></i> Hide History';
            } else {
                section.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-history"></i> Show History';
            }
        }

        // Invite Link Functions
        function copyInviteLink() {
            const inviteLink = document.getElementById('inviteLink');
            inviteLink.select();
            inviteLink.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
        
        function shareInviteLink() {
            const inviteLink = document.getElementById('inviteLink').value;
            const groupName = "{{ group.name|escapejs }}";
            
            if (navigator.share) {
                navigator.share({
                    title: `Join ${groupName} on HisaabKaro`,
                    text: `You've been invited to join the "${groupName}" group for expense tracking!`,
                    url: inviteLink
                }).catch(console.error);
            } else {
                copyInviteLink();
                alert('Link copied to clipboard! Share it with others to invite them to the group.');
            }
        }
        
        function regenerateInviteLink() {
            if (confirm('Are you sure you want to regenerate the invite link? The current link will no longer work.')) {
                alert('This feature will be implemented with the backend API.');
            }
        }
        
        // Expense Management Functions
        function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
                fetch(`/groups/{{ group.id }}/expenses/${expenseId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Refresh the page to show updated expenses
                    } else {
                        alert('Error deleting expense: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting expense. Please try again.');
                });
            }
        }
        
        function showExpenseHistory(expenseId) {
            fetch(`/groups/{{ group.id }}/expenses/${expenseId}/history/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let historyHtml = '<div class="expense-history">';
                    historyHtml += '<h5>Expense History</h5>';
                    historyHtml += '<div class="timeline">';
                    
                    data.history.forEach(entry => {
                        historyHtml += `
                            <div class="timeline-entry">
                                <div class="timeline-date">${entry.date}</div>
                                <div class="timeline-action">${entry.action}</div>
                                <div class="timeline-user">by ${entry.user}</div>
                                ${entry.details ? `<div class="timeline-details">${entry.details}</div>` : ''}
                            </div>
                        `;
                    });
                    
                    historyHtml += '</div></div>';
                    
                    // Show in a modal or alert (for now using alert, can be replaced with modal)
                    alert('Expense History:\n' + data.history.map(h => `${h.date}: ${h.action} by ${h.user}`).join('\n'));
                } else {
                    alert('Error loading history: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading history. Please try again.');
            });
        }
    </script>
</div>

<!-- Chart Modal -->
<div class="chart-modal" id="chartModal">
    <div class="chart-modal-content">
        <div class="chart-modal-header">
            <h5>{{ group.name }} - Expense Analysis</h5>
            <button class="chart-close" onclick="closeChartModal()">&times;</button>
        </div>
        <div class="chart-modal-body">
            <div class="chart-options">
                <div class="chart-option" data-type="day">
                    <i class="fas fa-calendar-day"></i>
                    <span>Single Day</span>
                </div>
                <div class="chart-option" data-type="month">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Single Month</span>
                </div>
                <div class="chart-option" data-type="range">
                    <i class="fas fa-calendar-week"></i>
                    <span>Date Range</span>
                </div>
            </div>
            
            <div class="date-inputs" id="dateInputs">
                <div class="row">
                    <div class="col-md-6">
                        <label for="startDate">Start Date:</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-6" id="endDateCol">
                        <label for="endDate">End Date:</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
                <button class="chart-generate-btn" onclick="generateChart()">Generate Chart</button>
            </div>
            
            <div class="chart-container" id="chartContainer">
                <canvas id="expenseChart" class="chart-canvas"></canvas>
                <div class="chart-stats" id="chartStats">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Modal -->
<div class="chat-modal" id="chatModal">
    <div class="chat-modal-content">
        <div class="chat-modal-header">
            <h5>{{ group.name }} - Group Chat</h5>
            <button class="chat-close" onclick="closeChatModal()">&times;</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be populated by JavaScript -->
        </div>
        <div class="chat-input-container">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="Type your message..."
                rows="1"
                onkeypress="handleChatKeyPress(event)"
            ></textarea>
            <button class="chat-send-button" id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Chat functionality variables
let chatSocket = null;
let currentGroupId = {{ group.id }};
let unreadCount = 0;

// WebSocket connection
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/group/${currentGroupId}/chat/`;
    
    chatSocket = new WebSocket(wsUrl);
    
    chatSocket.onopen = function(e) {
        console.log('Chat WebSocket connected');
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'chat_message') {
            addMessageToChat(data.message);
            if (!document.getElementById('chatModal').classList.contains('show') && !data.message.is_own) {
                updateUnreadCount(1);
            }
        } else if (data.type === 'recent_messages') {
            loadRecentMessages(data.messages);
        }
    };
    
    chatSocket.onclose = function(e) {
        console.log('Chat WebSocket disconnected');
        // Attempt to reconnect after 3 seconds
        setTimeout(connectWebSocket, 3000);
    };
    
    chatSocket.onerror = function(e) {
        console.error('Chat WebSocket error:', e);
    };
}

// Chat modal functions
function openChatModal(groupId) {
    document.getElementById('chatModal').classList.add('show');
    
    if (!chatSocket) {
        connectWebSocket();
    }
    
    // Reset unread count when opening chat
    resetUnreadCount();
    
    // Focus on input
    document.getElementById('chatInput').focus();
}

function closeChatModal() {
    document.getElementById('chatModal').classList.remove('show');
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message
        }));
        
        input.value = '';
        autoResizeTextarea(input);
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
    autoResizeTextarea(event.target);
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
}

function addMessageToChat(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = `message ${message.is_own ? 'own' : 'other'}`;
    
    const timestamp = new Date(message.timestamp).toLocaleString();
    
    messageElement.innerHTML = `
        <div class="message-bubble">
            ${escapeHtml(message.content)}
        </div>
        <div class="message-info">
            ${message.is_own ? 'You' : escapeHtml(message.sender_name)} • ${timestamp}
        </div>
    `;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function loadRecentMessages(messages) {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    messages.forEach(message => {
        addMessageToChat(message);
    });
}

function updateUnreadCount(increment) {
    unreadCount += increment;
    const badge = document.getElementById('unreadBadge');
    
    if (unreadCount > 0) {
        badge.style.display = 'flex';
        badge.textContent = unreadCount > 100 ? '100+' : unreadCount.toString();
    } else {
        badge.style.display = 'none';
    }
}

function resetUnreadCount() {
    unreadCount = 0;
    document.getElementById('unreadBadge').style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close chat modal when clicking outside
document.getElementById('chatModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeChatModal();
    }
});

// Auto-resize textarea on input
document.getElementById('chatInput').addEventListener('input', function(e) {
    autoResizeTextarea(e.target);
});
</script>
{% endblock %}
